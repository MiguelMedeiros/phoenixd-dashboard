name: Release Desktop App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

env:
  PHOENIXD_VERSION: '0.3.4'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.id }}
      release_upload_url: ${{ steps.create-release.outputs.upload_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.get-version.outputs.version }}
          release_name: Phoenixd Dashboard v${{ steps.get-version.outputs.version }}
          body: |
            ## Phoenixd Dashboard Desktop v${{ steps.get-version.outputs.version }}

            ### Downloads

            | Platform | Download |
            |----------|----------|
            | macOS (Apple Silicon) | `Phoenixd-Dashboard_${{ steps.get-version.outputs.version }}_aarch64.dmg` |
            | macOS (Intel) | `Phoenixd-Dashboard_${{ steps.get-version.outputs.version }}_x64.dmg` |
            | Windows | `Phoenixd-Dashboard_${{ steps.get-version.outputs.version }}_x64-setup.exe` |
            | Linux (AppImage) | `Phoenixd-Dashboard_${{ steps.get-version.outputs.version }}_amd64.AppImage` |
            | Linux (deb) | `Phoenixd-Dashboard_${{ steps.get-version.outputs.version }}_amd64.deb` |

            ### Installation

            1. Download the appropriate file for your operating system
            2. Run the installer
            3. Launch Phoenixd Dashboard
            4. The app will automatically set up phoenixd and all required services

            ### What's New

            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.
          draft: true
          prerelease: ${{ contains(steps.get-version.outputs.version, 'alpha') || contains(steps.get-version.outputs.version, 'beta') || contains(steps.get-version.outputs.version, 'rc') }}

  build-macos:
    needs: create-release
    strategy:
      matrix:
        include:
          - target: aarch64-apple-darwin
            runner: macos-14
            phoenixd_binary: phoenixd-aarch64-apple-darwin
          - target: x86_64-apple-darwin
            runner: macos-14
            phoenixd_binary: phoenixd-x86_64-apple-darwin
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install dependencies
        run: |
          npm ci
          npm ci --prefix frontend
          npm ci --prefix backend
          npm ci --prefix desktop

      - name: Download phoenixd binary
        run: |
          mkdir -p desktop/binaries
          curl -L -o phoenix.zip "https://github.com/ACINQ/phoenixd/releases/download/v${PHOENIXD_VERSION}/phoenix-${PHOENIXD_VERSION}-macos-$([ '${{ matrix.target }}' = 'aarch64-apple-darwin' ] && echo 'arm64' || echo 'x64').zip"
          unzip phoenix.zip
          find . -name "phoenixd" -type f -exec cp {} desktop/binaries/${{ matrix.phoenixd_binary }} \;
          chmod +x desktop/binaries/${{ matrix.phoenixd_binary }}

      - name: Prepare SQLite schema
        run: |
          cd backend
          cp prisma/schema.sqlite.prisma prisma/schema.prisma
          npx prisma generate

      - name: Build frontend
        run: npm run build:frontend

      - name: Build backend
        run: npm run build:backend

      - name: Prepare resources
        run: |
          chmod +x desktop/scripts/*.sh
          desktop/scripts/prepare-resources.sh

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: desktop
          tauriScript: npm run tauri
          args: --target ${{ matrix.target }}

      - name: Upload artifacts
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.release_upload_url }}
          asset_path: desktop/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
          asset_name: Phoenixd-Dashboard_${{ matrix.target }}.dmg
          asset_content_type: application/octet-stream

  build-windows:
    needs: create-release
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          npm ci
          npm ci --prefix frontend
          npm ci --prefix backend
          npm ci --prefix desktop

      - name: Download phoenixd binary
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path desktop/binaries
          Invoke-WebRequest -Uri "https://github.com/ACINQ/phoenixd/releases/download/v$env:PHOENIXD_VERSION/phoenix-$env:PHOENIXD_VERSION-windows-x64.zip" -OutFile phoenix.zip
          Expand-Archive -Path phoenix.zip -DestinationPath phoenix-extracted
          Get-ChildItem -Recurse -Filter "phoenixd.exe" | Copy-Item -Destination "desktop/binaries/phoenixd-x86_64-pc-windows-msvc.exe"

      - name: Prepare SQLite schema
        run: |
          cd backend
          copy prisma\schema.sqlite.prisma prisma\schema.prisma
          npx prisma generate

      - name: Build frontend
        run: npm run build:frontend

      - name: Build backend
        run: npm run build:backend

      - name: Prepare resources (Windows)
        shell: pwsh
        run: |
          # Create resources directory
          New-Item -ItemType Directory -Force -Path desktop/resources/binaries
          New-Item -ItemType Directory -Force -Path desktop/resources/backend
          New-Item -ItemType Directory -Force -Path desktop/resources/frontend
          
          # Copy phoenixd
          Copy-Item "desktop/binaries/phoenixd-x86_64-pc-windows-msvc.exe" "desktop/resources/binaries/phoenixd.exe"
          
          # Copy backend
          Copy-Item -Recurse "backend/dist" "desktop/resources/backend/"
          Copy-Item -Recurse "backend/node_modules" "desktop/resources/backend/"
          Copy-Item "backend/package.json" "desktop/resources/backend/"
          New-Item -ItemType Directory -Force -Path desktop/resources/backend/prisma
          Copy-Item "backend/prisma/schema.prisma" "desktop/resources/backend/prisma/"
          
          # Copy frontend standalone
          Copy-Item -Recurse "frontend/.next/standalone/*" "desktop/resources/frontend/"
          New-Item -ItemType Directory -Force -Path desktop/resources/frontend/.next/static
          Copy-Item -Recurse "frontend/.next/static/*" "desktop/resources/frontend/.next/static/"
          New-Item -ItemType Directory -Force -Path desktop/resources/frontend/public
          Copy-Item -Recurse "frontend/public/*" "desktop/resources/frontend/public/"

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: desktop
          tauriScript: npm run tauri

      - name: Upload NSIS installer
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.release_upload_url }}
          asset_path: desktop/src-tauri/target/release/bundle/nsis/*.exe
          asset_name: Phoenixd-Dashboard_x64-setup.exe
          asset_content_type: application/octet-stream

  build-linux:
    needs: create-release
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          npm ci
          npm ci --prefix frontend
          npm ci --prefix backend
          npm ci --prefix desktop

      - name: Download phoenixd binary
        run: |
          mkdir -p desktop/binaries
          curl -L -o phoenix.zip "https://github.com/ACINQ/phoenixd/releases/download/v${PHOENIXD_VERSION}/phoenix-${PHOENIXD_VERSION}-linux-x64.zip"
          unzip phoenix.zip
          find . -name "phoenixd" -type f -exec cp {} desktop/binaries/phoenixd-x86_64-unknown-linux-gnu \;
          chmod +x desktop/binaries/phoenixd-x86_64-unknown-linux-gnu

      - name: Prepare SQLite schema
        run: |
          cd backend
          cp prisma/schema.sqlite.prisma prisma/schema.prisma
          npx prisma generate

      - name: Build frontend
        run: npm run build:frontend

      - name: Build backend
        run: npm run build:backend

      - name: Prepare resources
        run: |
          chmod +x desktop/scripts/*.sh
          desktop/scripts/prepare-resources.sh

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: desktop
          tauriScript: npm run tauri

      - name: Upload AppImage
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.release_upload_url }}
          asset_path: desktop/src-tauri/target/release/bundle/appimage/*.AppImage
          asset_name: Phoenixd-Dashboard_amd64.AppImage
          asset_content_type: application/octet-stream

      - name: Upload deb
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.release_upload_url }}
          asset_path: desktop/src-tauri/target/release/bundle/deb/*.deb
          asset_name: Phoenixd-Dashboard_amd64.deb
          asset_content_type: application/octet-stream

  generate-checksums:
    needs: [create-release, build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Download release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p assets
          cd assets
          
          # Get release assets
          RELEASE_ID=${{ needs.create-release.outputs.release_id }}
          
          # Download all assets using GitHub API
          gh release download "v${{ steps.get-version.outputs.version }}" --repo ${{ github.repository }} --pattern "*.dmg" --pattern "*.exe" --pattern "*.AppImage" --pattern "*.deb" || true
          
          ls -la

      - name: Generate SHA256 checksums
        run: |
          cd assets
          sha256sum * > SHA256SUMS.txt || echo "No files to checksum"
          cat SHA256SUMS.txt

      - name: Import GPG key and sign
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [ -n "$GPG_PRIVATE_KEY" ]; then
            echo "$GPG_PRIVATE_KEY" | base64 --decode | gpg --batch --import
            echo "$GPG_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback --armor --detach-sign assets/SHA256SUMS.txt
            mv SHA256SUMS.txt.asc assets/
          else
            echo "GPG_PRIVATE_KEY not set, skipping signing"
          fi

      - name: Upload SHA256SUMS.txt
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.release_upload_url }}
          asset_path: assets/SHA256SUMS.txt
          asset_name: SHA256SUMS.txt
          asset_content_type: text/plain

      - name: Upload SHA256SUMS.txt.asc (GPG signature)
        if: hashFiles('assets/SHA256SUMS.txt.asc') != ''
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.release_upload_url }}
          asset_path: assets/SHA256SUMS.txt.asc
          asset_name: SHA256SUMS.txt.asc
          asset_content_type: text/plain

  publish-release:
    needs: [create-release, build-macos, build-windows, build-linux, generate-checksums]
    runs-on: ubuntu-latest
    steps:
      - name: Publish release
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ needs.create-release.outputs.release_id }},
              draft: false
            });

services:
  phoenixd:
    image: acinq/phoenixd:latest
    container_name: phoenixd
    restart: unless-stopped
    networks:
      - phoenixd-network
    dns:
      - 8.8.8.8
      - 1.1.1.1
    command: '--agree-to-terms-of-service --http-bind-ip 0.0.0.0 ${PHOENIXD_CHAIN:+--chain=${PHOENIXD_CHAIN}}'
    ports:
      - '9740:9740'
    volumes:
      - ./data/phoenixd:/phoenix/.phoenix
    healthcheck:
      test: ['CMD-SHELL', "echo 'healthcheck'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  postgres:
    image: postgres:16-alpine
    container_name: phoenixd-postgres
    restart: unless-stopped
    networks:
      - phoenixd-network
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-phoenixd}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-phoenixd_secret}
      POSTGRES_DB: ${POSTGRES_DB:-phoenixd_dashboard}
    ports:
      - '5433:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'pg_isready -U ${POSTGRES_USER:-phoenixd} -d ${POSTGRES_DB:-phoenixd_dashboard}',
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: phoenixd-backend
    restart: unless-stopped
    networks:
      - phoenixd-network
    # Run as root to access Docker socket (required for Tor/Tailscale container management)
    user: root
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 4000
      DATABASE_URL: postgresql://${POSTGRES_USER:-phoenixd}:${POSTGRES_PASSWORD:-phoenixd_secret}@postgres:5432/${POSTGRES_DB:-phoenixd_dashboard}?schema=public
      PHOENIXD_URL: http://phoenixd:9740
      PHOENIXD_PASSWORD: ${PHOENIXD_PASSWORD:-}
      DOCKER_HOST: unix:///var/run/docker.sock
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    ports:
      - '4001:4000'
    depends_on:
      postgres:
        condition: service_healthy
      phoenixd:
        condition: service_started
    volumes:
      - ./backend/src:/app/src:ro
      - ./data/phoenixd:/phoenix-data:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./services/tor:/tor-config:ro
      - ./services/tailscale:/tailscale-config:ro
      - ./services/cloudflared:/cloudflared-config:ro
      - ./data/cloudflared:/cloudflared-data
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:4000/health']
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:4001}
        NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-ws://localhost:4001}
    container_name: phoenixd-frontend
    restart: unless-stopped
    networks:
      - phoenixd-network
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:4001}
      NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-ws://localhost:4001}
    ports:
      - '3000:3000'
    depends_on:
      - backend
    volumes:
      - ./frontend/src:/app/src:ro

  # Tor SOCKS5 Proxy - managed dynamically by backend
  tor:
    build:
      context: ./services/tor
      dockerfile: Dockerfile
    container_name: phoenixd-tor
    restart: unless-stopped
    networks:
      - phoenixd-network
    volumes:
      - tor_data:/var/lib/tor
    profiles:
      - tor
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'curl --socks5 localhost:9050 --connect-timeout 10 https://check.torproject.org/api/ip 2>/dev/null | grep -q IsTor || exit 1',
        ]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 60s

  # Tailscale VPN - managed dynamically by backend for remote access
  tailscale:
    build:
      context: ./services/tailscale
      dockerfile: Dockerfile
    container_name: phoenixd-tailscale
    restart: unless-stopped
    networks:
      - phoenixd-network
    cap_add:
      - NET_ADMIN
      - NET_RAW
    environment:
      TS_AUTHKEY: ${TS_AUTHKEY:-}
      TS_HOSTNAME: ${TS_HOSTNAME:-phoenixd-dashboard}
    volumes:
      - tailscale_data:/var/lib/tailscale
    profiles:
      - tailscale
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'tailscale status --json | jq -e ".Self.Online == true" || exit 1',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Cloudflare Tunnel - managed dynamically by backend for public access
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: phoenixd-cloudflared
    restart: unless-stopped
    networks:
      - phoenixd-network
    command: tunnel --no-autoupdate run --token ${CLOUDFLARED_TOKEN:-}
    profiles:
      - cloudflared

networks:
  phoenixd-network:
    driver: bridge

volumes:
  postgres_data:
  tor_data:
  tailscale_data:
